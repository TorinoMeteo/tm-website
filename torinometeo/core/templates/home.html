{% extends 'base.html' %}
{% load realtime_tags %}
{% load blog_tags %}
{% load webcam_tags %}

{% block extra_js %}
    <script src="//code.highcharts.com/highcharts.js" type="text/javascript"></script>
    <script src="//code.highcharts.com/modules/exporting.js" type="text/javascript"></script>
    <script src="https://rawgit.com/TorinoMeteo/tm-forecast/master/js/tmforecast.js"></script>
{% endblock %}

{% block jumbotron %}
    {% realtime_jumbotron %}
{% endblock %}

{% block content %}
    {% realtime_line %}

    <div class="img-overlay" style="position: relative; padding-top: 160px;">
        <canvas id="canvas" style="position: absolute; top: 0; left: 0; bottom: 0; right: 0"></canvas>
        <div class="container">
            <div class="row">
                <div class="col-sm-12 col-md-6 col-lg-8 home-col-12">
                    {% blog_featured %}
                </div>
                <div class=" col-sm-12 col-md-6 col-lg-4 home-col-3">
                    <section style="background: #FDFBE3; opacity: .7;" class="forecast-wrapper">
                        <div class="content">
                            <tmdayforecast tm-date="{% now "Y-m-d" %}" tm-oncomplete="">
                                <h1>Previsioni del tempo</h1>
                            </tmdayforecast>
                            <p><a href="{% url 'forecast-view' %}">BOLLETTINO COMPLETO <i class="fa fa-arrow-right"></i></a></p>
                        </div>
                    </section>
                </div>
            </div>
            <!-- <script>window.tm.tmp = function() { tm.sameHeightColumns('.blog-featured-article', '.forecast-wrapper'); }</script> -->
        </div>
    </div>
    <div class="section-webcams">
        <div class="container">
            <p class="text-center" style="margin-bottom: 0">
                <i class="fa fa-camera fa-3x"></i>
                <span><a href="/webcam/">Scopri</a> tutte le nostre webcam!</span>
            </p>
        </div>
    </div>
    <div class="section-webcams-widgets">
        <div class="container">
            {% webcam_widget %}
        </div>
    </div>
    <script>
$(function () {
	var canvas = $("#canvas")[0];
	canvas.width = $(window).width();
	canvas.height = $(window).height();
	var ctx = canvas.getContext("2d");

	// resize
	$(window).on("resize", function () {
		canvas.width = $(window).width();
		canvas.height = $(window).height();
		ctx.fillStyle = "#102B62";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
	});

	// init
	ctx.fillStyle = "#000";
	ctx.fillRect(0, 0, canvas.width, canvas.height);
	// objects
	var listFire = [];
	var listFirework = [];
	var fireNumber = 15;
	var center = { x: canvas.width / 2, y: canvas.height / 4 };
	var range = 100;
	for (var i = 0; i < fireNumber; i++) {
		var fire = {
			x: (Math.random() * range) / 2 - range / 4 + center.x,
			y: Math.random() * range * 2 + canvas.height,
			size: Math.random() + 0.5,
			fill: "#fd1",
			vx: Math.random() - 0.5,
			vy: -(Math.random() + 4),
			ax: Math.random() * 0.02 - 0.01,
			far: Math.random() * range + (center.y - range)
		};
		fire.base = {
			x: fire.x,
			y: fire.y,
			vx: fire.vx
		};
		//
		listFire.push(fire);
	}

	function randColor() {
		var r = Math.floor(Math.random() * 256);
		var g = Math.floor(Math.random() * 256);
		var b = Math.floor(Math.random() * 256);
		var color = "rgb($r, $g, $b)";
		color = color.replace("$r", r);
		color = color.replace("$g", g);
		color = color.replace("$b", b);
		return color;
	}

	(function loop() {
		requestAnimationFrame(loop);
		update();
		draw();
	})();

	function update() {
		for (var i = 0; i < listFire.length; i++) {
			var fire = listFire[i];
			//
			if (fire.y <= fire.far) {
				// case add firework
				var color = randColor();
				for (var i = 0; i < fireNumber * 5; i++) {
					var firework = {
						x: fire.x,
						y: fire.y,
						size: Math.random() + 1.5,
						fill: color,
						vx: Math.random() * 5 - 2.5,
						vy: Math.random() * -5 + 1.5,
						ay: 0.05,
						alpha: 1,
						life: Math.round((Math.random() * range) / 2) + range / 2
					};
					firework.base = {
						life: firework.life,
						size: firework.size
					};
					listFirework.push(firework);
				}
				// reset
				fire.y = fire.base.y;
				fire.x = fire.base.x;
				fire.vx = fire.base.vx;
				fire.ax = Math.random() * 0.02 - 0.01;
			}
			//
			fire.x += fire.vx;
			fire.y += fire.vy;
			fire.vx += fire.ax;
		}

		for (var i = listFirework.length - 1; i >= 0; i--) {
			var firework = listFirework[i];
			if (firework) {
				firework.x += firework.vx;
				firework.y += firework.vy;
				firework.vy += firework.ay;
				firework.alpha = firework.life / firework.base.life;
				firework.size = firework.alpha * firework.base.size;
				firework.alpha = firework.alpha > 0.6 ? 1 : firework.alpha;
				//
				firework.life--;
				if (firework.life <= 0) {
					listFirework.splice(i, 1);
				}
			}
		}
	}

	function draw() {
		// clear
		ctx.globalCompositeOperation = "source-over";
		ctx.globalAlpha = 0.18;
		ctx.fillStyle = "#102B62";
		ctx.fillRect(0, 0, canvas.width, canvas.height);

		// re-draw
		ctx.globalCompositeOperation = "screen";
		ctx.globalAlpha = 1;
		for (var i = 0; i < listFire.length; i++) {
			var fire = listFire[i];
			ctx.beginPath();
			ctx.arc(fire.x, fire.y, fire.size, 0, Math.PI * 2);
			ctx.closePath();
			ctx.fillStyle = fire.fill;
			ctx.fill();
		}

		for (var i = 0; i < listFirework.length; i++) {
			var firework = listFirework[i];
			ctx.globalAlpha = firework.alpha;
			ctx.beginPath();
			ctx.arc(firework.x, firework.y, firework.size, 0, Math.PI * 2);
			ctx.closePath();
			ctx.fillStyle = firework.fill;
			ctx.fill();
		}
	}
});
    </script>
{% endblock %}

